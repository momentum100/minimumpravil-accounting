# ACNE INC - Система учета

## Обзор

Система учета для ACNE INC, компании, занимающейся рекламой в социальных сетях. Эта система управляет финансовыми операциями, отслеживает расходы и контролирует балансы для различных пользователей, включая баеров, агентства и финансовый отдел.

## Архитектура системы

Система использует принцип двойной записи в бухгалтерии со следующими основными компонентами:

1. **Управление пользователями**: Обрабатывает различные роли и разрешения
2. **Управление счетами**: Отслеживает балансы для всех субъектов системы
3. **Система транзакций**: Записывает все финансовые операции с записями кредита/дебета
4. **Отчетная панель**: Настраиваемые представления на основе ролей пользователей

## Основные сущности

### Пользователи и роли
- **Владелец (Owner)**: Полный доступ ко всем данным и отчетам. Управляет командами, может приглашать новых пользователей в систему.
- **Финансист (Finance)**: Управляет распределением средств и операционными расходами
- **Баер (Buyer)**: Специалисты по рекламе, использующие аккаунты в социальных сетях. Каждый баер принадлежит к определенной команде.
- **Агентство (Agency)**: Виртуальные пользователи, представляющие контрагентов/поставщиков аккаунтов в социальных сетях

### Типы счетов
- **Системные счета (SYSTEM)**:
  - SYSTEM_ROMA: Основной счет владельца (обычно с отрицательным балансом)
  - SYSTEM_USDT: Операционный счет финансового отдела
  - FINANCE: Счет финансового отдела

- **Счета агентств (AGENCY)**: 
  - Отдельные счета для каждого рекламного агентства (AGENCY_1, AGENCY_2 и т.д.)

## Структура базы данных

### teams (команды)
- uuid
- name (название команды)
- created_at
- updated_at

### users (пользователи)
- uuid
- telegram_id (null для виртуальных пользователей)
- role (роль: owner, finance, buyer, agency)
- name (имя)
- team_id (ссылка на teams, null для не-баеров)
- sub2 (текст, содержит теги баера из внешней системы, например, "tag1,tag2")
- active (активность)
- is_virtual (виртуальный: boolean, true для агентств)
- contact_info (контактная информация для агентств)

### accounts (счета)
- uuid
- user_id (ссылка на пользователя)
- type (тип счета: SYSTEM, AGENCY, CREO, PROXY, ACCOUNTS, OTHER)
- description (описание)
- created_at
- updated_at

> Важно: Баланс счета не хранится в таблице accounts, а вычисляется динамически на основе записей в transaction_lines по формуле: Баланс = Сумма кредитов - Сумма дебетов.

### operations (операции)
- uuid
- date (дата)
- description (описание)
- amount (количество)
- tariff (тариф, опционально)
- total (всего = количество * тариф)
- created_by (создано пользователем, ссылка на users)
- buyer_id (идентификатор баера, опционально)
- comment (комментарий)
- created_at (дата и время создания записи)
- updated_at (дата и время обновления записи)

### transactions (транзакции)
- uuid
- operation_id (идентификатор операции)
- date (дата)
- description (описание)
- status (статус)
- accounting_period (учетный период, к которому относится транзакция, например "2025.01")
- created_at (дата и время создания записи)

### transaction_lines (строки транзакций)
- uuid
- transaction_id (идентификатор транзакции)
- account_id (идентификатор счета)
- debit (дебет)
- credit (кредит)
- description (описание строки транзакции)
- created_at (дата и время создания записи)

## Пример операционной таблицы

Пример структуры операционной таблицы, используемой пользователями:

| Дата             | Имя          | Категория | Количество | Тариф  | Общее   |
|------------------|--------------|-----------|------------|--------|---------|
| 2025.01.01 20:26 | VAS          | 250       | 6,00       | 18,00  | 108,00  |
| 2025.01.01 20:26 | SHYM         | 250       | 6,00       | 18,00  | 108,00  |
| 2025.01.03 18:17 | VAS          | PROXY     | 23,00      | 1,00   | 23,00   |
| 2025.01.03 23:59 | OP GAMBLING  | CREO      | 60,00      | 1,00   | 60,00   |

### Правила доступа к операционной таблице

- **Владелец (Owner)**: Видит и может редактировать все записи
- **Финансист (Finance)**: Видит все записи, может добавлять и редактировать операционные расходы для всех пользователей
- **Баер (Buyer)**: Видит только свои записи, может добавлять информацию о собственных расходах

Записи в операционной таблице служат основанием для создания транзакций в системе двойной записи.

## Типы операционных таблиц

Для удобства работы разных пользователей и разделения функциональности, система использует различные операционные таблицы:

### 1. daily_expenses (Ежедневные расходы)

Таблица для отслеживания ежедневных расходов баеров.

| Дата | Имя | Категория | Количество | Тариф | Общее | Комментарий |
|------|-----|-----------|------------|-------|-------|-------------|
| 2025.01.03 | VAS | PROXY | 23,00 | 1,00 | 23,00 | Покупка прокси |

- **Кто вносит**: Баеры, Финансисты
- **Особенности**: Всегда положительные значения
- **Интерфейс**: Упрощенный для быстрого внесения расходов

### 2. adjustments (Корректировки)

Таблица для корректировок расходов после сверки с агентствами.

| Дата внесения | Имя баера | Категория | Период корректировки | Сумма корректировки | Комментарий |
|---------------|-----------|-----------|---------------------|---------------------|-------------|
| 2025.02.05 | VAS | AGENCY_1 | 2025.01 | -100,00 | Корректировка после сверки с агентством |

- **Кто вносит**: Только Финансисты
- **Особенности**: 
  - Может содержать как положительные, так и отрицательные значения
  - **Важно**: Корректировки относятся к предыдущему месяцу (периоду), а не к дате внесения
  - В отчетах корректировки учитываются в том месяце, к которому они относятся
- **Интерфейс**: Требует указания причины корректировки и выбора периода, к которому она относится

#### Обработка корректировок в системе двойной записи

При создании транзакций на основе записей из таблицы корректировок:

1. В поле `created_at` записывается фактическая дата внесения корректировки
2. В поле `accounting_period` устанавливается период, к которому относится корректировка
3. При формировании отчетов корректировки учитываются в периоде, указанном в `accounting_period`

Это позволяет:
- Сохранить информацию о реальной дате внесения корректировки
- Корректно учесть корректировку в том периоде, к которому она относится
- Формировать точные финансовые отчеты по периодам

#### Учет по периодам в системе

В системе двойной записи поле `accounting_period` размещается только в таблице `transactions`, а не в `transaction_lines` по следующим причинам:

1. **Целостность данных:**
   - Транзакция представляет собой единое атомарное событие
   - Все строки одной транзакции (дебет и кредит) всегда относятся к одному учетному периоду

2. **Оптимизация структуры базы данных:**
   - Предотвращается дублирование данных
   - Исключается риск несогласованности периодов внутри одной транзакции
   - Соблюдаются принципы нормализации данных

3. **Эффективность запросов:**
   - Для формирования отчетов используются SQL запросы с группировкой по `accounting_period`
   - Пример запроса для отчета по расходам за период:
   ```sql
   SELECT 
       t.accounting_period, 
       a.type,
       SUM(tl.debit) as total_expenses
   FROM 
       transactions t
   JOIN 
       transaction_lines tl ON t.uuid = tl.transaction_id
   JOIN 
       accounts a ON tl.account_id = a.uuid
   WHERE 
       t.accounting_period = '2025.01'
   GROUP BY 
       t.accounting_period, a.type;
   ```

Такая организация обеспечивает корректную работу с данными при наличии операций, относящихся к прошлым периодам, и позволяет формировать точные финансовые отчеты.

### 3. fund_transfers (Перемещение средств)

Таблица для отслеживания перемещения средств между счетами.

| Дата | Счет-отправитель | Счет-получатель | Сумма | Комментарий |
|------|------------------|-----------------|-------|-------------|
| 2025.01.01 | SYSTEM_ROMA | AGENCY_1 | 20000,00 | Пополнение счета агентства |

- **Кто вносит**: Владелец, Финансисты
- **Особенности**: Создает транзакции между различными счетами
- **Интерфейс**: Выбор счетов из списка доступных

Все записи из этих таблиц преобразуются в транзакции в системе двойной записи, но разделение на уровне интерфейса позволяет упростить работу пользователей и применять различные правила валидации для разных типов операций.

## Ключевые рабочие процессы

1. **Распределение средств**:
   - Владелец переводит средства агентствам и финансовому отделу
   - Финансовый отдел распределяет средства на операционные расходы

2. **Отслеживание расходов**:
   - Расходы агентства регистрируются по каждому баеру
   - Операционные расходы (прокси, креативы и т.д.) отслеживаются финансовым отделом

3. **Учет доходов**:
   - Доходы получаются из трекера Keitaro путем ежедневных запросов.
   - Результаты сохраняются в отдельной таблице `income_records` со следующей структурой:
     - `id`: Уникальный идентификатор записи
     - `amount`: Сумма дохода
     - `created_at`: Дата и время получения данных
     - `updated_at`: Дата и время обновления записи (если применимо)

4. **Отчетность**:
   - Фильтрация расходов агентств
   - Отслеживание эффективности баеров
   - Мониторинг общего баланса

## Аутентификация

Система использует Telegram для аутентификации и идентификации пользователей.

## Панели управления

В зависимости от ролей пользователей доступны различные панели управления:

1. **Панель владельца**: Общее финансовое состояние, обзор всех счетов
2. **Панель финансиста**: Распределение средств, управление расходами
3. **Панель баера**: Личные расходы и показатели эффективности
